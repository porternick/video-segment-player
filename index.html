<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>YouTube Segments Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  #player { width: 100%; aspect-ratio: 16/9; margin-top: 1rem; }
  li.playing { background-color: #e9f3ff; }
</style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="mb-4">YouTube Segments Player</h1>

  <div class="mb-3">
    <label for="baseUrl" class="form-label">Base YouTube link (watch / youtu.be / embed / ID)</label>
    <input id="baseUrl" type="text" class="form-control"
      value="https://www.youtube.com/watch?v=dQw4w9WgXcQ">
  </div>

  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr><th>#</th><th>Start (mm:ss)</th><th>End (mm:ss)</th></tr>
      </thead>
      <tbody id="segments"></tbody>
    </table>
  </div>

  <button id="startBtn" class="btn btn-primary">Start Playlist</button>

  <div id="player" class="mt-4"></div>

  <h5 class="mt-4">Queue</h5>
  <ul id="queueList" class="list-group"></ul>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- YouTube IFrame API -->
<script src="https://www.youtube.com/iframe_api"></script>
<script>
let player, playlist = [], current = 0;

// Build 10 rows of inputs
const segTable = document.getElementById("segments");
for (let i=0;i<10;i++) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${i+1}</td>
    <td><input type="text" class="form-control start" placeholder="mm:ss"></td>
    <td><input type="text" class="form-control end" placeholder="mm:ss"></td>`;
  segTable.appendChild(tr);
}

// mm:ss → seconds
function toSeconds(str) {
  if (!str) return null;
  str = str.trim();
  if (/^\d+$/.test(str)) return parseInt(str,10);
  if (/^\d+:\d{1,2}$/.test(str)) {
    const [m,s] = str.split(":").map(Number);
    return m*60+s;
  }
  return null;
}

// Extract ID from YouTube link or ID
function extractId(input) {
  input = input.trim();
  if (!input) return null;
  if (/^[A-Za-z0-9_-]{11}$/.test(input)) return input;
  try {
    const url = input.startsWith("http") ? new URL(input) : new URL("https://"+input);
    if (url.hostname.includes("youtu.be")) return url.pathname.slice(1);
    if (url.searchParams.get("v")) return url.searchParams.get("v");
    const parts = url.pathname.split("/");
    const idx = parts.indexOf("embed");
    if (idx >= 0 && parts[idx+1]) return parts[idx+1];
  } catch {}
  return null;
}

function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    events: { 'onStateChange': onPlayerStateChange }
  });
}

function onPlayerStateChange(event) {
  if (event.data === YT.PlayerState.ENDED) {
    current++;
    if (current < playlist.length) playIndex(current);
  }
}

function playIndex(i) {
  current = i;
  const {id, start, end} = playlist[i];
  player.loadVideoById({ videoId:id, startSeconds:start, endSeconds:end });
  document.querySelectorAll("#queueList li").forEach((li,idx)=>{
    li.classList.toggle("playing", idx===i);
    li.classList.toggle("list-group-item-primary", idx===i);
  });
}

document.getElementById("startBtn").onclick = () => {
  const id = extractId(document.getElementById("baseUrl").value);
  if (!id) { alert("Invalid YouTube link or ID"); return; }

  playlist = [];
  document.getElementById("queueList").innerHTML = "";

  const starts = document.querySelectorAll(".start");
  const ends = document.querySelectorAll(".end");
  for (let i=0;i<10;i++) {
    const s = toSeconds(starts[i].value);
    const e = toSeconds(ends[i].value);
    if (s!=null && e!=null && e>s) {
      playlist.push({id, start:s, end:e});
    }
  }

  playlist.forEach((item,i)=>{
    const li = document.createElement("li");
    li.textContent = `Segment ${i+1}: ${item.start}s–${item.end}s`;
    li.className = "list-group-item";
    document.getElementById("queueList").appendChild(li);
  });

  if (playlist.length) playIndex(0);
};
</script>
</body>
</html>
