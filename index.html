<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>YouTube Timestamps Queue (no API)</title>
<style>
  body { font-family: sans-serif; max-width: 720px; margin: 40px auto; padding: 0 1em; }
  h1 { font-size: 1.3em; margin-bottom: 0.5em; }
  textarea { width: 100%; height: 140px; margin-bottom: 10px; }
  button { padding: 6px 12px; margin-bottom: 20px; }
  iframe { width: 100%; aspect-ratio: 16/9; border: none; display: block; margin: auto; }
  ul { margin-top: 20px; padding-left: 1em; font-size: 0.9em; }
  li.playing { background: #eef; }
</style>
</head>
<body>

<h1>YouTube Timestamp Queue (no API)</h1>

<p>Paste YouTube links (watch, youtu.be, or embed). Add <code>?t=SECONDS</code> or <code>?start=…&end=…</code>. Examples:</p>

<pre>
https://www.youtube.com/watch?v=dQw4w9WgXcQ&t=43s&end=55
https://youtu.be/dQw4w9WgXcQ?start=60&end=75
dQw4w9WgXcQ?start=80&end=95
</pre>

<textarea id="urls" placeholder="Paste one link per line..."></textarea>
<br>
<button id="startBtn">Start Playlist</button>

<iframe id="ytplayer" allow="autoplay" allowfullscreen></iframe>

<ul id="queueList"></ul>

<script>
const frame = document.getElementById('ytplayer');
const queueList = document.getElementById('queueList');
let playlist = [];
let current = -1;
let timer = null;

// ---- URL Parsing ----
function parseYouTubeUrl(input) {
  input = input.trim();
  if (!input) return null;

  // If user pasted just an ID
  if (/^[A-Za-z0-9_-]{11}$/.test(input)) {
    return { id: input, start: null, end: null };
  }

  try {
    // Ensure URL object
    let url = input.startsWith('http') ? new URL(input) : new URL("https://" + input);

    let id = null;
    if (url.hostname.includes("youtu.be")) {
      id = url.pathname.slice(1);
    } else if (url.searchParams.get("v")) {
      id = url.searchParams.get("v");
    } else {
      // maybe /embed/VIDEOID
      const parts = url.pathname.split("/");
      const idx = parts.indexOf("embed");
      if (idx >= 0 && parts[idx+1]) id = parts[idx+1];
    }

    if (!id) return null;

    // Parse start/end
    let start = null, end = null;

    if (url.searchParams.has("start")) start = toSeconds(url.searchParams.get("start"));
    if (url.searchParams.has("end")) end = toSeconds(url.searchParams.get("end"));
    if (url.searchParams.has("t")) {
      const tval = url.searchParams.get("t");
      start = toSeconds(tval);
    }

    return { id, start, end };
  } catch(e) {
    return null;
  }
}

function toSeconds(str) {
  if (!str) return null;
  if (/^\d+$/.test(str)) return parseInt(str);
  const m = str.match(/(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s)?/);
  if (m) {
    return (parseInt(m[1]||0)*3600 + parseInt(m[2]||0)*60 + parseInt(m[3]||0));
  }
  return null;
}

function makeEmbedUrl(obj) {
  if (!obj || !obj.id) return null;
  const params = new URLSearchParams();
  if (obj.start != null) params.set("start", obj.start);
  if (obj.end != null) params.set("end", obj.end);
  params.set("autoplay", "1");
  return `https://www.youtube.com/embed/${obj.id}?${params.toString()}`;
}

// ---- Player Control ----
function playIndex(idx) {
  if (idx < 0 || idx >= playlist.length) return;
  current = idx;
  frame.src = playlist[current].embed;

  // highlight queue
  [...queueList.children].forEach((li, i) => {
    li.className = (i === current) ? "playing" : "";
  });

  // schedule next
  frame.onload = () => {
    clearTimeout(timer);
    const { start, end } = playlist[current];
    if (end != null && start != null && end > start) {
      const duration = (end - start) * 1000;
      timer = setTimeout(() => {
        if (current + 1 < playlist.length) playIndex(current + 1);
      }, duration + 500);
    }
  };
}

document.getElementById("startBtn").onclick = () => {
  const lines = document.getElementById("urls").value
    .split("\n").map(l => l.trim()).filter(Boolean);

  playlist = [];
  queueList.innerHTML = "";

  lines.forEach(line => {
    const parsed = parseYouTubeUrl(line);
    if (parsed) {
      const embed = makeEmbedUrl(parsed);
      playlist.push({ ...parsed, embed });
    }
  });

  // show queue
  playlist.forEach((item, i) => {
    const li = document.createElement("li");
    li.textContent = item.embed;
    queueList.appendChild(li);
  });

  if (playlist.length) playIndex(0);
};
</script>

</body>
</html>
